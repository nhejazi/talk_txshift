---
title: "Simulation results for R package `tmle3shift`"
author: "[Nima Hejazi](https://nimahejazi.org)"
date: '`r format(Sys.time(), "%Y %b %d (%a), %H:%M:%S")`'
output:
  html_document
---

```{r, echo=FALSE}
library(here)
library(data.table)
library(tidyverse)
library(patchwork)
options(repr.plot.width = 5, repr.plot.height = 4)  ## resizing plots
options(scipen = 999)  ## has scientific notation ever annoyed you?
sim_res <- readRDS(here("data", "tmle3shift-sims",
                        "01_simple-sim-res_2018-08-19_13:25:35.rds"))
truth <- 2
ci_level <- 0.95
```

```{r, echo=FALSE}
failed_sims <- lapply(sim_res, function(x) !complete.cases(x)) %>%
  lapply(sum) %>%
  bind_cols()
```

## Simulation structure:

For a single observational unit $O = (W, A, Y)$, data are simulated using the
following set of structural equations:
\begin{align*}
  W \sim Bern(p = 0.5)\\
  A \sim N(\mu = \gamma \cdot W, \sigma^2 = 1)\\
  Y = A + W + \epsilon,
\end{align*}
for $\gamma = 2$, being a multiplier of the effect of the baseline covariate $W$
on the natural value of the treatment $A$, and white noise $\epsilon \sim
N(0, 1)$. We consider the case of observing a data structure composed of $n$
replicates of $O$, i.e., $O_1, \ldots, O_n$. We employ the approach of assessing
the causal effect of a stochastic intervention, as implemented in the
[`tmle3shift` R package](http://tmle3shift.tlverse.org/), taking as our goal the
estimation of the counterfactual mean of the outcome under the additive shift
$\delta = 0.5$. We employ our approach across a variety of simulated sample
sizes $n_{\text{samp}} \in \{50, 250, 1000, 2000\}$. In all cases,
$n_{\text{sim}} = 1000$ simulations were performd at each sample size. The
results are summarized in both tabular and visual formats in the sequel.

## Tabular summaries of simulation results:

Below, we summarize the simulation results in terms of bias, Monte Carlo
variance, average standard error of the point estimate, and MSE:
```{r add_cis, echo=FALSE, message=FALSE, warning=FALSE}
results_with_cis <- lapply(sim_res, function(x) x[complete.cases(x),]) %>%
  bind_rows(.id = "id") %>%
  mutate(
    ci_lwr = param_est - (param_var * abs(qnorm(p = (1 - ci_level) / 2))),
    ci_upr = param_est + (param_var * abs(qnorm(p = (1 - ci_level) / 2))),
    covers = (ci_lwr <= truth & truth <= ci_upr),
    n_samp = as.factor(as.numeric(str_remove(id, "n_"))),
    id = NULL
  )
```

```{r make_summary, echo=FALSE, message=FALSE, warning=FALSE}
sim_res_summary <- results_with_cis %>%
  group_by(n_samp) %>%
  summarise(
    n_sim = n(),                         # how many complete simulations
    bias_avg = mean(param_est - truth),  # subtract truth for bias
    est_mc_var = var(param_est),
    se_avg = mean(param_var),
    mse = (bias_avg)^2 + est_mc_var,
    cvr = mean(covers)
  )
knitr::kable(sim_res_summary, format = "latex")
```

Additionally, we provide errors of the above summary measures:
```{r make_errors, echo=FALSE, message=FALSE, warning=FALSE}
sim_res_errors <- results_with_cis %>%
  group_by(n_samp) %>%
  summarise(
    n_sim = n(),
    bias_err = sqrt(var(param_est - truth) / n_sim) *
      abs(qnorm(p = (1 - ci_level) / 2)),
    est_mc_var_err = sqrt(var((param_est - mean(param_est))^2) / n_sim) *
      abs(qnorm(p = (1 - ci_level) / 2)),
    mse_err = sqrt(var(var(param_est) + (param_est - truth)^2) / n_sim) *
      abs(qnorm(p = (1 - ci_level) / 2))
  )
knitr::kable(sim_res_errors, format = "latex")
```

## Visual summaries of simulation results:

```{r plot_bias, echo=FALSE, message=FALSE, warning=FALSE}
p_bias_avg <- left_join(sim_res_summary, sim_res_errors) %>%
  ggplot(aes(x = n_samp, y = bias_avg)) +
  geom_errorbar(aes(ymin = bias_avg - bias_err, ymax = bias_avg + bias_err),
                width = 0.2, size = 2, color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue",
             size = 2) +
  geom_point(size = 5) +
  xlab("Sample Size") +
  ylab("Bias") +
  ggtitle("Average bias vanishing") +
  theme_bw() +
  theme(text = element_text(size = 22),
        axis.text.x = element_text(colour = 'black', size = 25),
        axis.text.y = element_text(colour = 'black', size = 25))

pdf(file = here("Figs", "tmle3shift-sims", "bias_plot.pdf"))
p_bias_avg
dev.off()
```

```{r plot_mcvar, echo=FALSE, message=FALSE, warning=FALSE}
p_mc_var <- left_join(sim_res_summary, sim_res_errors) %>%
  ggplot(aes(x = n_samp, y = est_mc_var)) +
  geom_errorbar(aes(ymin = est_mc_var - est_mc_var_err,
                    ymax = est_mc_var + est_mc_var_err),
                width = 0.2, size = 2, color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue",
             size = 2) +
  geom_point(size = 5) +
  xlab("Sample Size") +
  ylab("Monte Carlo Variance") +
  ggtitle("Monte Carlo variance vanishing") +
  theme_bw() +
  theme(text = element_text(size = 22),
        axis.text.x = element_text(colour = 'black', size = 25),
        axis.text.y = element_text(colour = 'black', size = 25))

pdf(file = here("Figs", "tmle3shift-sims", "mc_var_plot.pdf"))
p_mc_var
dev.off()
```

```{r plot_mse, echo=FALSE, message=FALSE, warning=FALSE}
p_mse <- left_join(sim_res_summary, sim_res_errors) %>%
  ggplot(aes(x = n_samp, y = mse)) +
  geom_errorbar(aes(ymin = mse - mse_err, ymax = mse + mse_err),
                width = 0.2, size = 2, color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue",
             size = 2) +
  geom_point(size = 5) +
  xlab("Sample Size") +
  ylab("Mean-squared Error (MSE)") +
  ggtitle("MSE vanishing") +
  theme_bw() +
  theme(text = element_text(size = 22),
        axis.text.x = element_text(colour = 'black', size = 25),
        axis.text.y = element_text(colour = 'black', size = 25))

pdf(file = here("Figs", "tmle3shift-sims", "mse_avg_plot.pdf"))
p_mse
dev.off()
```

```{r plot_avgse, echo=FALSE, message=FALSE, warning=FALSE}
p_se_avg <- sim_res_summary %>%
  ggplot(aes(x = n_samp, y = se_avg)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue",
             size = 2) +
  geom_point(size = 5) +
  xlab("Sample Size") +
  ylab("Avg. Standard Error") +
  ggtitle("Avg. Standard Error decreasing") +
  theme_bw() +
  theme(text = element_text(size = 22),
        axis.text.x = element_text(colour = 'black', size = 25),
        axis.text.y = element_text(colour = 'black', size = 25))

pdf(file = here("Figs", "tmle3shift-sims", "se_avg_plot.pdf"))
p_se_avg
dev.off()
```

```{r plot_ci, echo=FALSE, message=FALSE, warning=FALSE}
p_ci <- sim_res_summary %>%
  ggplot(aes(x = n_samp, y = cvr)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue",
             size = 2) +
  geom_point(size = 5) +
  xlab("Sample Size") +
  ylab("% CIs Covering the Truth") +
  ggtitle("CI coverage increasing") +
  theme_bw() +
  theme(text = element_text(size = 22),
        axis.text.x = element_text(colour = 'black', size = 25),
        axis.text.y = element_text(colour = 'black', size = 25))

pdf(file = here("Figs", "tmle3shift-sims", "coverage_plot.pdf"))
p_ci
dev.off()
```

